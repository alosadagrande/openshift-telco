{
  "ignition": {
    "version": "3.1.0"
  },
  "systemd": {
    "units": [{
        "name": "var-mnt.mount",
        "enabled": true,
        "contents": "[Unit]\nDescription=Mount precached container images\nBefore=precache-images.service\nStopWhenUnneeded=true\n\n[Mount]\nWhat=/dev/disk/by-partlabel/data\nWhere=/var/mnt\nType=xfs\nTimeoutSec=120\n\n[Install]\nWantedBy=multi-user.target"
    },
    {
        "name": "precache-images.service",
        "enabled": true,
        "contents": "[Unit]\nDescription=Extracts the precached images into containers storage\nRequires=var-mnt.mount\nAfter=var-mnt.mount\nBefore=agent.service\n\n[Service]\nType=oneshot\nUser=root\nWorkingDirectory=/var/mnt/ai-images\nExecStart=bash /usr/local/bin/extract-ai.sh\nExecStartPost=systemctl disable var-mnt.mount\nExecStop=systemctl stop var-mnt.mount\nTimeoutStopSec=180\n\n[Install]\nWantedBy=multi-user.target default.target\nWantedBy=agent.service"
     }
    ]
  },
  "storage": {
    "files": [
    {
      "overwrite": true,
      "path": "/usr/local/bin/extract-ai.sh",
      "mode": 755,
      "user": {
          "name": "root"
      },
      "contents": { "source": "data:,%23%21%2Fbin%2Fbash%0A%0AFOLDER%3D%22%24%7BFOLDER%3A-%24%28pwd%29%7D%22%0AOCP_RELEASE_LIST%3D%22%24%7BOCP_RELEASE_LIST%3A-initial-images.txt%7D%22%0ABINARY_FOLDER%3D%2Fusr%2Flocal%2Fbin%0A%0Apushd%20%24FOLDER%0A%0Atotal_copies%3D%24%28sort%20-u%20%24BINARY_FOLDER%2F%24OCP_RELEASE_LIST%20%7C%20wc%20-l%29%20%20%23%20Required%20to%20keep%20track%20of%20the%20pull%20task%20vs%20total%0Acurrent_copy%3D1%0A%0Awhile%20read%20-r%20line%3B%0Ado%0A%20%20uri%3D%24%28echo%20%22%24line%22%20%7C%20awk%20%27%7Bprint%241%7D%27%29%0A%20%20%23tar%3D%24%28echo%20%22%24line%22%20%7C%20awk%20%27%7Bprint%242%7D%27%29%0A%20%20podman%20image%20exists%20%24uri%0A%20%20if%20%5B%5B%20%24%3F%20-eq%200%20%5D%5D%3B%20then%0A%20%20%20%20%20%20echo%20%22Skipping%20existing%20image%20%24tar%22%0A%20%20%20%20%20%20echo%20%22Copying%20%24%7Buri%7D%20%5B%24%7Bcurrent_copy%7D%2F%24%7Btotal_copies%7D%5D%22%0A%20%20%20%20%20%20current_copy%3D%24%28%28current_copy%20%2B%201%29%29%0A%20%20%20%20%20%20continue%0A%20%20fi%0A%20%20tar%3D%24%28echo%20%22%24uri%22%20%7C%20%20rev%20%7C%20cut%20-d%20%22%2F%22%20-f1%20%7C%20rev%20%7C%20tr%20%22%3A%22%20%22_%22%29%0A%20%20tar%20zxvf%20%24%7Btar%7D.tgz%0A%20%20if%20%5B%20%24%3F%20-eq%200%20%5D%3B%20then%20rm%20-f%20%24%7Btar%7D.gz%3B%20fi%0A%20%20echo%20%22Copying%20%24%7Buri%7D%20%5B%24%7Bcurrent_copy%7D%2F%24%7Btotal_copies%7D%5D%22%0A%20%20skopeo%20copy%20dir%3A%2F%2F%24%28pwd%29%2F%24%7Btar%7D%20containers-storage%3A%24%7Buri%7D%0A%20%20if%20%5B%20%24%3F%20-eq%200%20%5D%3B%20then%20rm%20-rf%20%24%7Btar%7D%3B%20current_copy%3D%24%28%28current_copy%20%2B%201%29%29%3B%20fi%0Adone%20%3C%20%24%7BBINARY_FOLDER%7D%2F%24%7BOCP_RELEASE_LIST%7D%0A%0Aexit%200"
    }
  },
  {
    "overwrite": true,
    "path": "/usr/local/bin/initial-images.txt",
    "mode": 420,
    "user": {
        "name": "root"
    },
    "contents": { "source": "data:text/plain;charset=utf-8;base64,cXVheS5pby9hbG9zYWRhZy90cm91Ymxlc2hvb3Q6bGF0ZXN0CnF1YXkuaW8vb3BlbnNoaWZ0LXJlbGVhc2UtZGV2L29jcC1yZWxlYXNlOjQuMTAuMjAteDg2XzY0CnJlZ2lzdHJ5LnJlZGhhdC5pby9yaGFpLXRlY2gtcHJldmlldy9hc3Npc3RlZC1pbnN0YWxsZXItcmhlbDg6djEuMC4wLTE3NQpyZWdpc3RyeS5yZWRoYXQuaW8vcmhhaS10ZWNoLXByZXZpZXcvYXNzaXN0ZWQtaW5zdGFsbGVyLWFnZW50LXJoZWw4OnYxLjAuMC0xNTYKcmVnaXN0cnkucmVkaGF0LmlvL211bHRpY2x1c3Rlci1lbmdpbmUvYXNzaXN0ZWQtaW5zdGFsbGVyLWFnZW50LXJoZWw4OnYyLjAuMS01CnJlZ2lzdHJ5LnJlZGhhdC5pby9tdWx0aWNsdXN0ZXItZW5naW5lL2Fzc2lzdGVkLWluc3RhbGxlci1yaGVsOEBzaGEyNTY6M2VhMDU4MmIxNGU3ODcxNGIyMjlhZDM4MTkxMTI1NmEzOTdlMGYwN2E5MWY1MTAyNjY3ZTJjY2VmZTdlN2Y3ZgpxdWF5LmlvL29wZW5zaGlmdC1yZWxlYXNlLWRldi9vY3AtdjQuMC1hcnQtZGV2QHNoYTI1Njo5NDFiNmVlY2I0ZWNkYTU3OTZmZTA3MGUzOWU5MzI4MTU5ZTQ4MmZlZDNkY2YwOWJmOGQ2YzE4OWY2MmEzYzFhCnF1YXkuaW8vb3BlbnNoaWZ0LXJlbGVhc2UtZGV2L29jcC12NC4wLWFydC1kZXZAc2hhMjU2OjJkMTZmNWMyZjM1NmQ1NDE1NGQ3ODg2OWFjNmIwODg4NTJkNjIzY2Y1YmFkOWQ2ZTFjOWM1MDY0MDc0MmVlOGMKcXVheS5pby9vcGVuc2hpZnQtcmVsZWFzZS1kZXYvb2NwLXY0LjAtYXJ0LWRldkBzaGEyNTY6ZWM5ZDZiOTJkNWVkZDg1MTMyNzM2MTkwZTk1OWU5MmIzNTA2YzVhZDg0MmY1MThiOTc3ZmUwZjNlY2I2ZWE0YgpxdWF5LmlvL29wZW5zaGlmdC1yZWxlYXNlLWRldi9vY3AtdjQuMC1hcnQtZGV2QHNoYTI1Njo5NTc5ZmExY2M5OGU2OGQwZmQ0MTRiNGM4NTExZTE0MDYyMTg2ZDg1YWUxYzhhZWIxZjIyOTJlMmVkYzQ2YWEyCnF1YXkuaW8vb3BlbnNoaWZ0LXJlbGVhc2UtZGV2L29jcC12NC4wLWFydC1kZXZAc2hhMjU2OjM1ZjFjODVhNDhiMGMxNjU2MmZkYzJmZDY4MGViZWYxYTQ3ODUxODk4NjJiNWMwOGM3YTdlMmJiZTI4NWZjMWIKcXVheS5pby9vcGVuc2hpZnQtcmVsZWFzZS1kZXYvb2NwLXY0LjAtYXJ0LWRldkBzaGEyNTY6MWM3ZmU2NzdhY2RmM2JhNjcwZWU2MmFlMjUyNGFkYmU4NDk3MjYwMWI1NmNlOWMxN2E5OWUzYWRlZTc3NGRjMwpxdWF5LmlvL29wZW5zaGlmdC1yZWxlYXNlLWRldi9vY3AtdjQuMC1hcnQtZGV2QHNoYTI1Njo1Y2E4NDkyNzBjNGNhMTgyYjI2NzBlOTY1YmNhMGNlYTcxMDA0NTgxZmYxMjhhNzZjMjMyYWFjMDNkNzk2NDljCnF1YXkuaW8vb3BlbnNoaWZ0LXJlbGVhc2UtZGV2L29jcC12NC4wLWFydC1kZXZAc2hhMjU2OjAwMmJlOWI0MDAxZDA5MGFiNGVkM2E5Yzg5NTBiZTE0ZjZiZGU2NGRmMTE3OGQ5ZWVmODZmMDE3YzA4OTgwYzcKcXVheS5pby9vcGVuc2hpZnQtcmVsZWFzZS1kZXYvb2NwLXY0LjAtYXJ0LWRldkBzaGEyNTY6OTExZDUzMDA2MDU4ZmRjODY2OWI4MjRkYTU5YzhmZmJkZjdhZGZkYTQyNzQ0OGQxNjFlMzZlMWUxOTYwODFlZApxdWF5LmlvL29wZW5zaGlmdC1yZWxlYXNlLWRldi9vY3AtdjQuMC1hcnQtZGV2QHNoYTI1NjoxMDBkMWY3NmRhZDM0ZWVlYjYyN2IyNzNkOWVmNDMxMjdlMGJiNTk5NDRkN2U5NWRiNTE5YTU1Y2I0YmRiZjc4CnF1YXkuaW8vb3BlbnNoaWZ0LXJlbGVhc2UtZGV2L29jcC12NC4wLWFydC1kZXZAc2hhMjU2OjI3Yzc0ODY0ZmRkMzRlZTIzOGUzYmU4MTdmMmE5YjFkYmI5ZDAyY2U1M2QyZTJkMzY0MGI5MTZiN2JmZTg2MmUKcXVheS5pby9vcGVuc2hpZnQtcmVsZWFzZS1kZXYvb2NwLXY0LjAtYXJ0LWRldkBzaGEyNTY6YzA5MTg5YjBiMDNiZDYzMWFkMDRkYjdmMDUxOWQ3MTdmZWM0YTExMzIxZDJkNjY1ZWU5ZGMxMGMxMTQ2NmY3YwpxdWF5LmlvL29wZW5zaGlmdC1yZWxlYXNlLWRldi9vY3AtdjQuMC1hcnQtZGV2QHNoYTI1NjoyZTFjNjU0MTkxNjgwYzhlODY5YTE2MTI0YzhkMmRkODFlODk2ZGE0YWVmZjU2Nzc1NzBhNTU2ZDllMjNmMTljCnF1YXkuaW8vb3BlbnNoaWZ0LXJlbGVhc2UtZGV2L29jcC12NC4wLWFydC1kZXZAc2hhMjU2OmZjYjNjYjZiMjJmZTQ5NDYzMzY5NTU0NzJjZmJmZDBkNDcwMzRiODM3ZjMxMTNjYmNmMjE5YmU3N2FkNjRjYWUK"
   }
 }
 ]  
 }
}
